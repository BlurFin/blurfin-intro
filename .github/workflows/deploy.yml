name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/blurfin-intro

            echo "📥 Pulling latest changes from main branch..."
            git fetch origin
            git reset --hard origin/main

            echo "📦 Installing dependencies..."
            npm ci --production

            echo "🔨 Building project..."
            npm run build

            echo "🔄 Restarting PM2 process..."
            pm2 restart blurfin-server

            echo "✅ Deployment completed successfully!"
            pm2 status

            echo "🌐 Site is now live at https://blurfin.com"
