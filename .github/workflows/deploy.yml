name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Validate Secrets and Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 2m
          script: |
            echo "ğŸ” Validating server connection and secrets..."
            echo "âœ… HOST: ${{ secrets.HOST }} - Connection successful"
            echo "âœ… USERNAME: ${{ secrets.USERNAME }} - Login successful"
            echo "âœ… SSH_KEY: Valid and working"
            echo ""
            echo "ğŸ“‹ Server Information:"
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            echo "Server time: $(date)"
            echo "Server uptime: $(uptime)"
            echo "Disk usage: $(df -h / | tail -1)"
            echo "Memory usage: $(free -h | grep Mem)"
            echo ""
            echo "ğŸ“‚ Project directory check:"
            echo "Home directory contents:"
            ls -la ~/
            echo ""
            echo "Checking project directory paths:"
            echo "~/blurfin-intro exists: $([ -d ~/blurfin-intro ] && echo 'YES' || echo 'NO')"
            echo "/home/ubuntu/blurfin-intro exists: $([ -d /home/ubuntu/blurfin-intro ] && echo 'YES' || echo 'NO')"
            echo ""
            if [ -d "/home/ubuntu/blurfin-intro" ]; then
              echo "âœ… Project directory exists at /home/ubuntu/blurfin-intro"
              cd /home/ubuntu/blurfin-intro
              echo "Current branch: $(git branch --show-current)"
              echo "Last commit: $(git log --oneline -1)"
            elif [ -d "~/blurfin-intro" ]; then
              echo "âœ… Project directory exists at ~/blurfin-intro"
              cd ~/blurfin-intro
              echo "Current branch: $(git branch --show-current)"
              echo "Last commit: $(git log --oneline -1)"
            else
              echo "âŒ Project directory not found in both locations"
              echo "Let's check if there are any similar directories:"
              find /home/ubuntu -maxdepth 2 -name "*blurfin*" -type d 2>/dev/null || echo "No blurfin directories found"
              exit 1
            fi
            echo ""
            echo "ğŸ”§ PM2 status check:"
            pm2 describe blurfin-server > /dev/null 2>&1 && echo "âœ… PM2 process exists" || echo "âš ï¸ PM2 process not found (will be created)"
            echo ""
            echo "ğŸ¯ All validation checks passed! Ready for deployment."

      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 15m
          script: |
            # Navigate to project directory
            if [ -d "/home/ubuntu/blurfin-intro" ]; then
              cd /home/ubuntu/blurfin-intro
            else
              cd ~/blurfin-intro
            fi

            echo "ğŸ“¥ Pulling latest changes from main branch..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ“¦ Installing dependencies with Yarn..."
            yarn install

            echo "ğŸ”§ Ensuring Express v4 compatibility..."
            yarn remove express
            yarn add express@^4.21.0

            echo "ğŸ”¨ Building project..."
            npm run build

            echo "ğŸ”„ Restarting PM2 process..."
            pm2 restart blurfin-server

            echo "âœ… Deployment completed successfully!"
            pm2 status
            pm2 logs blurfin-server --lines 5 --nostream

            echo "ğŸŒ Site is now live at https://blurfin.com"
